<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Historic Hurricanes</title>

  <!-- Load Calcite components from CDN -->
  <script type="module" src="https://js.arcgis.com/calcite-components/3.2.1/calcite.esm.js"></script>

  <!-- Load the ArcGIS Maps SDK for JavaScript from CDN -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.32/esri/themes/dark/main.css" />
  <script src="https://js.arcgis.com/4.32/"></script>

  <!-- Load Map components from CDN-->
  <script type="module" src="https://js.arcgis.com/4.32/map-components/"></script>
  <link rel="stylesheet" href="main.css" />
</head>

<body class="calcite-mode-dark">
  <calcite-shell>
    <div slot="header" id="header">
      <div id="heading">
        Animated Hurricane Tracks
      </div>
      <div id="subheading">Explore hurricanes from 2005 to 2006 using the time slider below.</div>
    </div>
    <arcgis-map>
      <arcgis-zoom position="top-left"></arcgis-zoom>
      <arcgis-expand position="top-left" expand-icon="legend" label="Legend">
        <arcgis-placement slot="panel-top">
          <div id="legend-content">
            <h3>Legend</h3>
            <img src="legend.png" id="legend-img" alt="Hurricane Image" />
          </div>
        </arcgis-placement>
      </arcgis-expand>
    </arcgis-map>
    <calcite-shell-panel id="slider-panel" slot="panel-bottom" layout="horizontal">
      <arcgis-time-slider layout="auto" mode="cumulative-from-start" reference-element="arcgis-map"
        play-rate="20"></arcgis-time-slider>
    </calcite-shell-panel>
  </calcite-shell>

  <script type="module">
    const [WebMap, Color, GeoJSONLayer] = await $arcgis.import([
      "@arcgis/core/WebMap.js",
      "@arcgis/core/Color.js",
      "@arcgis/core/layers/GeoJSONLayer.js",
    ]);

    const yearSlider = document.querySelector("arcgis-time-slider");
    const viewElement = document.querySelector("arcgis-map");

    const startYear = 2005;
    const endYear = 2006;

    // Esri color ramps - Plasma
    const plasma = ["#8d01efff", "#bf09eeff", "#ff51bdff", "#ff9d82ff", "#ffc666ff", "#ffff35ff"];

    const colors = plasma.map((c, i) => {
      const newColor = new Color(c);
      newColor.a = i / 5;
      return newColor;
    });

    // Label expression for the latest observation
    const latestObservationsNameLabelExpression = `
      var label = iif($feature.Category > 0, $feature.Name + ' (' + $feature.Category + ')', $feature.Name);
      if(!HasValue($view, [ "timeProperties", "currentEnd" ])) {
        return null;
      }
      var e = $view.timeProperties.currentEnd;
      var t = $feature.ISO_time;
      var d = DateDiff(e, t, 'days');

      // only show label if the storm is active
      return iif(d <= 3, label, null);
    `;

    const dateDiffExpression = `
      if(!HasValue($view, [ "timeProperties", "currentEnd" ])) {
        return null;
      }
      var e = $view.timeProperties.currentEnd;
      var t = $feature.ISO_time;
      var d = DateDiff(e, t, 'days');
      return d;
    `;

    const latestObservationsLowerLabelExpression = `
      var labelParts = [
        Text($feature.ISO_time, "MMM D, Y h:mm A"),
        iif($feature.Category > 0, "Category " + $feature.Category, "Tropical Storm"),
        $feature.wmo_wind + " mph"
      ];
      var label = Concatenate(labelParts, TextFormatting.NewLine);
      if(!HasValue($view, [ "timeProperties", "currentEnd" ])) {
        return null;
      }
      var e = $view.timeProperties.currentEnd;
      var t = $feature.ISO_time;
      var d = DateDiff(e, t, 'days');
      iif(d <= 10, label, null);
    `;

    const previousObservationsRenderer = {
      type: "simple",
      label: "Previous hurricane location",
      symbol: {
        type: "simple-marker",
        outline: {
          color: (() => {
            const c = colors[5].clone();
            c.a = 0.2;
            return c;
          })(),
          width: 0,
        },
      },
      // vary size and color of previous observations based on category
      visualVariables: [
        {
          type: "size",
          field: "Category",
          legendOptions: {
            showLegend: true,
          },
          stops: [
            { value: 0, size: 2 },
            { value: 1, size: 4 },
            { value: 2, size: 5 },
            { value: 3, size: 6 },
            { value: 4, size: 8 },
            { value: 5, size: 10 },
          ],
        },
        {
          type: "color",
          field: "Category",
          legendOptions: {
            showLegend: true,
          },
          stops: [
            { value: 0, color: colors[0] },
            { value: 1, color: colors[1] },
            { value: 2, color: colors[2] },
            { value: 3, color: colors[3] },
            { value: 4, color: colors[4] },
            { value: 5, color: colors[5] },
          ],
        },
        {
          // fade previous observations based on position of time slider handle
          type: "opacity",
          valueExpression: dateDiffExpression,
          legendOptions: {
            showLegend: true,
          },
          stops: [
            { value: 7, opacity: 1 },
            { value: 14, opacity: 0.18 },
          ],
        },
      ],
    };

    const latestObservationsRenderer = {
      type: "simple",
      symbol: {
        type: "picture-marker",
        url: "https://developers.arcgis.com/javascript/latest//assets/img/guide/visualization/demos/cyclone-marker.gif",
        height: 20,
        width: 20,
      },
      // vary size of latest observation based on category
      visualVariables: [
        {
          type: "size",
          field: "Category",
          stops: [
            { value: 1, size: 12 },
            { value: 2, size: 16 },
            { value: 3, size: 24 },
            { value: 4, size: 36 },
            { value: 5, size: 56 },
          ],
        },
        {
          // vary opacity of latest observation based on whether the storm is active
          // an active storm is one that has an observation at the position of the time slider
          // or was active within 3 days of the current time (this is for a fade out effect)
          type: "opacity",
          valueExpression: dateDiffExpression,
          legendOptions: {
            showLegend: false,
          },
          stops: [
            { value: 0, opacity: 1 },
            { value: 3, opacity: 0 },
          ],
        },
      ],
    };

    const trackLinesRenderer = {
      type: "simple",
      symbol: {
        type: "simple-line",
        color: (() => {
          const c = colors[3].clone();
          c.a = 1;
          return c;
        })(),
        width: 0.5,
      },
      visualVariables: [
        {
          type: "opacity",
          valueExpression: dateDiffExpression,
          legendOptions: {
            showLegend: false,
          },
          stops: [
            { value: 7, opacity: 1 },
            { value: 14, opacity: 0.18 },
          ],
        },
      ],
    };

    const layer = new GeoJSONLayer({
      effect: "bloom(2, 1px, 10%)",
      title: `Hurricanes (${startYear} - ${endYear})`,
      portalItem: {
        id: "13e2698365a14b0c9e403e38dc92f779",
      },
      definitionExpression: `Year >= ${startYear} AND Year <= ${endYear}`,
      popupTemplate: {
        title: "{Name}",
        content: [
          {
            type: "text",
            text: "Category {Category} storm with that occurred at {ISO_time}.",
          },
          {
            type: "fields",
            fieldInfos: [
              {
                fieldName: "wmo_pres",
                label: "Pressure",
              },
              {
                fieldName: "wmo_wind",
                label: "Wind Speed (mph)",
              },
            ],
          },
        ],
        fieldInfos: [
          {
            fieldName: "ISO_time",
            format: {
              dateFormat: "short-date-short-time",
            },
          },
        ],
      },
      timeInfo: {
        startField: "ISO_time",
        // field containing unique identifier for each track
        trackIdField: "Serial_Num",
      },
      trackInfo: {
        enabled: true,
        // display all observations in the track for duration of user session
        maxDisplayDuration: {
          value: 0,
          unit: "minutes",
        },
        // display all observations for each track
        maxDisplayObservationsPerTrack: 0,
        popupTemplate: {
          title: "Hurricane {Name}",
          content: "Average wind speed: {AVG_WIND} mph",
          fieldInfos: [
            {
              fieldName: "AVG_WIND",
              label: "Average Wind Speed",
              format: {
                places: 0,
                digitSeparator: true,
              },
            },
          ],
        },
        previousObservations: {
          // show previous observations as marker symbols
          visible: true,
          renderer: previousObservationsRenderer,
          // label recent observations with a fully opaque label
          // label older observations with a semi-transparent label
          labelingInfo: [
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: plasma[5],
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 9,
                  family: "Noto Sans",
                  weight: "normal",
                },
                xoffset: 0,
                yoffset: 0,
              },
              minScale: 2311163,
              maxScale: 0,
              labelPlacement: "center-right",
              labelExpressionInfo: {
                expression: `
                  var labelParts = [
                    $feature.Name,
                    Text($feature.ISO_time, "MMM D, Y h:mm A"),
                    iif($feature.Category > 0, "Category " + $feature.Category, "Tropical Storm"),
                    $feature.wmo_wind + " mph"
                  ];
                  var label = Concatenate(labelParts, TextFormatting.NewLine);
                  if(!HasValue($view, [ "timeProperties", "currentEnd" ])) {
                    return null;
                  }
                  var e = $view.timeProperties.currentEnd;
                  var t = $feature.ISO_time;
                  var d = DateDiff(e, t, 'days');
                  iif(d <= 10, label, null);
                `,
              },
            },
            {
              symbol: {
                type: "text",
                color: (() => {
                  const c = colors[5].clone();
                  c.a = 0.35;
                  return c;
                })(),
                haloColor: "rgba(0,0,0,0.5)",
                haloSize: 1,
                font: {
                  size: 9,
                  family: "Noto Sans",
                  weight: "normal",
                },
                xoffset: 0,
                yoffset: 0,
              },
              minScale: 2311163,
              maxScale: 0,
              labelPlacement: "center-right",
              labelExpressionInfo: {
                expression: `
                  var labelParts = [
                    $feature.Name,
                    Text($feature.ISO_time, "MMM D, Y h:mm A"),
                    iif($feature.Category > 0, "Category " + $feature.Category, "Tropical Storm"),
                    $feature.wmo_wind + " mph"
                  ];
                  var label = Concatenate(labelParts, TextFormatting.NewLine);
                  if(!HasValue($view, [ "timeProperties", "currentEnd" ])) {
                    return null;
                  }
                  var e = $view.timeProperties.currentEnd;
                  var t = $feature.ISO_time;
                  var d = DateDiff(e, t, 'days');
                  iif(d > 10, label, null);
                `,
              },
            },
          ],
        },
        latestObservations: {
          // show latest observation as an animated picture marker
          visible: true,
          labelsVisible: true,
          // vary label size and color based on category
          labelingInfo: [
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: plasma[5],
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 24,
                  family: "Noto Sans",
                  weight: "bold",
                },
                xoffset: -10,
                yoffset: -15,
              },
              labelPlacement: "above-right",
              labelExpressionInfo: {
                expression: latestObservationsNameLabelExpression,
              },
              where: "Category = 5",
            },
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: plasma[4],
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 20,
                  family: "Noto Sans",
                  weight: "bold",
                },
                xoffset: -5,
                yoffset: -10,
              },
              labelPlacement: "above-right",
              labelExpressionInfo: {
                expression: latestObservationsNameLabelExpression,
              },
              where: "Category = 4",
            },
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: plasma[3],
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 18,
                  family: "Noto Sans",
                  weight: "bold",
                },
                xoffset: -5,
                yoffset: -8,
              },
              labelPlacement: "above-right",
              labelExpressionInfo: {
                expression: latestObservationsNameLabelExpression,
              },
              where: "Category = 3",
            },
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: plasma[2],
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 14,
                  family: "Noto Sans",
                  weight: "bold",
                },
                xoffset: -5,
                yoffset: -5,
              },
              labelPlacement: "above-right",
              labelExpressionInfo: {
                expression: latestObservationsNameLabelExpression,
              },
              where: "Category = 2",
            },
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: plasma[1],
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 11,
                  family: "Noto Sans",
                  weight: "bold",
                },
                xoffset: -5,
                yoffset: -5,
              },
              labelPlacement: "above-right",
              labelExpressionInfo: {
                expression: latestObservationsNameLabelExpression,
              },
              where: "Category = 1",
            },
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: plasma[0],
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 8,
                  family: "Noto Sans",
                  weight: "bold",
                },
                xoffset: -5,
                yoffset: -5,
              },
              labelPlacement: "above-right",
              labelExpressionInfo: {
                expression: latestObservationsNameLabelExpression,
              },
              where: "Category = 0",
            },
            {
              // when the user zooms in, show more detailed information
              // about the storm, including the time of the observation
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: "white",
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 10,
                  family: "Noto Sans",
                  weight: "normal",
                },
                xoffset: -6,
                yoffset: -2,
              },
              where: "Category = 5",
              minScale: 2311163,
              maxScale: 0,
              labelPlacement: "center-right",
              labelExpressionInfo: {
                expression: latestObservationsLowerLabelExpression,
              },
            },
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: "white",
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 10,
                  family: "Noto Sans",
                  weight: "normal",
                },
                xoffset: -3,
                yoffset: -8,
              },
              where: "Category >= 3 AND Category < 5",
              minScale: 2311163,
              maxScale: 0,
              labelPlacement: "center-right",
              labelExpressionInfo: {
                expression: latestObservationsLowerLabelExpression,
              },
            },
            {
              deconflictionStrategy: "none",
              symbol: {
                type: "text",
                color: "white",
                haloColor: "black",
                haloSize: 1,
                font: {
                  size: 8,
                  family: "Noto Sans",
                  weight: "normal",
                },
                xoffset: -3,
                yoffset: -12,
              },
              minScale: 2311163,
              maxScale: 0,
              where: "Category <= 2",
              labelPlacement: "center-right",
              labelExpressionInfo: {
                expression: latestObservationsLowerLabelExpression,
              },
            },
          ],
          renderer: latestObservationsRenderer,
        },
        trackLines: {
          visible: true,
          renderer: trackLinesRenderer,
        },
        fields: [
          {
            name: "AVG_WIND",
            onStatisticField: "wmo_wind",
            statisticType: "avg",
          },
        ],
      },
    });

    viewElement.map = new WebMap({
      portalItem: {
        id: "5d36c6e206674a4f960f12e4e83f767b",
      },
      layers: [layer],
    });

    const start = new Date(startYear, 0, 1);
    const end = new Date(endYear, 11, 31);

    yearSlider.fullTimeExtent = {
      start,
      end,
    };
    yearSlider.timeExtent = {
      start,
      end: start,
    };
    yearSlider.stops = {
      interval: {
        value: 6,
        unit: "hours",
      },
    };
    viewElement.timeExtent = yearSlider.timeExtent;
  </script>
</body>

</html>